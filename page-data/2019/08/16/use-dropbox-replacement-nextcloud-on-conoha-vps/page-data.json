{"componentChunkName":"component---src-templates-post-js","path":"/2019/08/16/use-dropbox-replacement-nextcloud-on-conoha-vps/","result":{"data":{"wordpressPost":{"id":"073ed065-27db-5f0f-920f-1e24b3f9139b","title":"Dropbox 代替の Nextcloud を ConoHa VPS で使用する","excerpt":"<p>はじめに Nextcloud とは Nextcloud とは、オープンソースの Dropbox みたいなソフトです。自前のサーバーに Nextcloud サーバーをインストールし、PC やスマホの Nextcloud ク [&hellip;]</p>\n","slug":"use-dropbox-replacement-nextcloud-on-conoha-vps","content":"\n<h2>はじめに</h2>\n\n\n\n<h3>Nextcloud とは</h3>\n\n\n\n<p>Nextcloud とは、オープンソースの Dropbox みたいなソフトです。自前のサーバーに Nextcloud サーバーをインストールし、PC やスマホの Nextcloud クライアントからアクセスする形です。詳しくは以下の公式サイトをご覧下さい。</p>\n\n\n\n<p><a href=\"https://nextcloud.com/\">Nextcloud</a></p>\n\n\n\n<h3>今回やりたいこと </h3>\n\n\n\n<p>やりたいことは、Nextcloud をセットアップして、社内メンバーで使うファイル置き場として使う事です。</p>\n\n\n\n<p>以下、要件です。</p>\n\n\n\n<ul><li>ファイルの種類はテキスト、Office ファイル、音声、動画など</li><li>ファイルサイズは結構大きいものがある（〜100MB）</li><li>使う人数はとりあえず数人（メンバー全員が使うわけではない）</li><li>現在の合計データ量は数十GB</li></ul>\n\n\n\n<h3>なぜ Nextcloud か</h3>\n\n\n\n<p>今まで Dropbox の無料版を使っていましたが、容量が足りなくなりました。有料のプランを検討しましたが、個人向けプランもビジネス向けプランも、急に値段が高くなります。2TB とか 3TB も要らないので、もう少し安くして欲しいです。</p>\n\n\n\n<ul><li><a href=\"https://www.dropbox.com/individual/plans-comparison\">個人向けプランの料金を比較 &#8211; Dropbox</a></li><li><a href=\"https://www.dropbox.com/business/pricing\">Dropbox Business の価格 &#8211; Dropbox Business</a></li></ul>\n\n\n\n<p>Box は 550円/ユーザー/月 から開始なので、Dropbox より随分使いやすい価格体系ですし、機能も Dropbox より豊富です。</p>\n\n\n\n<p><a href=\"https://www.box.com/pricing\">Box Pricing for Businesses &amp; Individuals | Box US</a></p>\n\n\n\n<p>ただ、せっかくなので何か新しいものを試してみたいと思って検索したところ、Nextcloud を知ったので、使ってみる事にしました。</p>\n\n\n\n<h3>なぜ ConoHa VPS か</h3>\n\n\n\n<p>Nextcloud のドキュメントを眺めたところ、結構セットアップが面倒くさそうだったので、WordPress のワンクリックインストール（多くのレンタルサーバー・VPS が提供している、ワンクリックで必要なソフトのインストール・セットアップが出来る仕組み）みたいなものをどっかで提供していないか、と調べたところ、以下の2つを見つけました。</p>\n\n\n\n<ul><li><a href=\"https://vps-news.sakura.ad.jp/2018/06/20/nextcloud/\">さくらのVPS、スタートアップスクリプト「CentOS_Nextcloud」を追加しました。 – さくらのVPSニュース</a></li><li><a href=\"https://www.conoha.jp/vps/function/startupscript/\">スタートアップスクリプト｜VPSならConoHa</a></li></ul>\n\n\n\n<p>この2つから、値段・必要な機能等を考えて、ConoHa VPS を使う事にしました。</p>\n\n\n\n<h2>Nextcloud のセットアップ</h2>\n\n\n\n<p>ここからは手順をざっと書いていきます。</p>\n\n\n\n<h3>インストール</h3>\n\n\n\n<p>まずは、ConoHa の管理画面からサーバーを追加する際に、スタートアップスクリプトで Nextcloud を選択します。詳しくはマニュアルを参照して下さい。</p>\n\n\n\n<p><a href=\"https://support.conoha.jp/v/startupscript_controlpanel/?btn_id=startupscript_startupscript_controlpanel&amp;_ga=2.30893439.1900261064.1565653102-2115928816.1564474801\">スタートアップスクリプトを使ってサーバーを追加する｜ConoHa VPSサポート</a></p>\n\n\n\n<p>そうすると、 <code>http://&lt;サーバーのIPアドレス&gt;/nextcloud</code> で Nextcloud にアクセス出来るようになります。その後は、画面に従って管理ユーザーの作成などを行えば、最低限使えるようになります。簡単ですね。</p>\n\n\n\n<p>ちなみに、ConoHa のマニュアルなどには書かれていないようですが、サーバーの <code>/root/nextcloud-configs</code> というファイルに、自動で作成された MySQL のユーザー名・パスワードなどが書かれています。</p>\n\n\n\n<h3>VirtualHost の設定</h3>\n\n\n\n<p><code>http://&lt;サーバーのIPアドレス&gt;/nextcloud</code> でアクセスするよりはホスト名でアクセスしたいので、VirtualHost の設定をします。</p>\n\n\n\n<p>CentOS なので、<code>/etc/httpd/conf.d/host.example.com.conf</code> というようなファイルを以下の内容で作成し、<code>service httpd restart</code> を実行します。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n&lt;VirtualHost *:80&gt;\n    ServerName host.example.com\n    DocumentRoot /var/www/html\n    ErrorLog /var/log/httpd/host.example.com-error_log\n    CustomLog /var/log/httpd/host.example.comt-access_log combined\n&lt;/VirtualHost&gt;\n</pre>\n\n\n<p>（DNS の設定はされている前提です。）</p>\n\n\n\n<h3>SSL (Let&#8217;s Encrypt) の設定</h3>\n\n\n\n<p>ConoHa では、SSL の設定をするスタートアップスクリプトもあるのですが、複数のスタートアップスクリプトを併用する事は出来ないようなので、SSL 証明書（Let&#8217;s Encrypt）の取得や設定は自分でやります。とは言え、Certbot や dehydrated を使えば簡単にできますし、ネット上に情報が沢山あるので、ここでは紹介しません。</p>\n\n\n\n<h3>.htaccess を有効にする</h3>\n\n\n\n<p>Nextcloud の管理画面にアクセスすると、現状の設定内容などを調べて、色々アドバイスをしてくれるのですが、その中の1つに「このままだと Nextcloud にアップロードしたファイルに誰でもアクセス出来てしまう」というようなメッセージがありました。</p>\n\n\n\n<p>Apache の設定に以下を追加して再起動すると、 <code>/var/www/html/nextcloud/data/.htaccess</code> の設定が有効になり、上の警告も消えます。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n    &lt;Directory /var/www/html/nextcloud&gt;\n        Options Indexes FollowSymLinks\n        AllowOverride All\n        Require all granted\n    &lt;/Directory&gt;\n</pre>\n\n\n<h2>Nextcloud のアップグレード</h2>\n\n\n\n<p>ここまでで、Nextcloud を普通に使えるようになったのですが、インストールされているバージョンは 12 というかなり古いもののようなので、ここから最新の 16 までアップグレードしていきます。</p>\n\n\n\n<p>とはいえ、基本的には画面から行えるので、そこまで大変ではありません。</p>\n\n\n\n<h3>12 -&gt; 13 は画面から</h3>\n\n\n\n<p>管理画面からアップグレードを行って下さい。詳しくは以下のドキュメントを参照して下さい。</p>\n\n\n\n<p><a href=\"https://docs.nextcloud.com/server/12/admin_manual/maintenance/update.html\">Upgrade via built-in updater — Nextcloud 12 Server Administration Manual 12 documentation</a></p>\n\n\n\n<h3>13 -&gt; 14 は、PHP のアップグレードが必要</h3>\n\n\n\n<p>ConoHa の Nextcloud スタートアップスクリプトでインストールすると、PHP は 5.6 がインストールされますが、Nextcloud 14 で、PHP のバージョン要件が変わったようですので、まずは PHP をアップグレードします。</p>\n\n\n\n<p>最初にインストールされているパッケージは以下の通りです。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\nphp56u-common-5.6.40-1.ius.el7.x86_64\nphp56u-mysqlnd-5.6.40-1.ius.el7.x86_64\nphp56u-xml-5.6.40-1.ius.el7.x86_64\nphp56u-cli-5.6.40-1.ius.el7.x86_64\nphp56u-pear-1.10.5-1.ius.el7.noarch\nphp56u-pdo-5.6.40-1.ius.el7.x86_64\nphp56u-pecl-jsonc-devel-1.3.10-2.ius.el7.x86_64\nphp56u-5.6.40-1.ius.el7.x86_64\nphp56u-gd-5.6.40-1.ius.el7.x86_64\nphp56u-mbstring-5.6.40-1.ius.el7.x86_64\nphp56u-process-5.6.40-1.ius.el7.x86_64\nphp56u-pecl-jsonc-1.3.10-2.ius.el7.x86_64\nphp56u-devel-5.6.40-1.ius.el7.x86_64\nphp56u-mcrypt-5.6.40-1.ius.el7.x86_64\nphp56u-imap-5.6.40-1.ius.el7.x86_64\n</pre>\n\n\n<p>これを全部削除して、PHP 7.2 をインストールします。7.3 ではダメなので注意して下さい。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n# PHP 5.6 の削除\nrpm -e $(rpm -qa 'php56*')\n# PHP 7.2 のインストール\nyum install mod_php72u php72u-mysqlnd php72u-xml php72u-cli php72u-pdo php72u-gd php72u-mbstring php72u-process php72u-json  php72u-imap\n</pre>\n\n\n<p>PHP 5.6 -&gt; 7.2 にあたって、いくつかのパッケージは無くなっていたりしていることに注意して下さい。</p>\n\n\n\n<p>その後、管理画面より Nextcloud を 14 にアップグレードして下さい。</p>\n\n\n\n<h3>14 -&gt; 15 は画面から＋MySQL の設定変更</h3>\n\n\n\n<p>14 から 15 へのアップグレードも管理画面から行えますが、アップグレード後の管理画面で、設定内容に関する警告がいくつか出ていると思います。そのうち、MySQL での utf8mb4 関連のものにまずは対処します。（utf8mb4 が何なのかが分からない方は、検索をお願いします。）</p>\n\n\n\n<p>Nextcloud のドキュメントは以下の通りです。</p>\n\n\n\n<p><a href=\"https://docs.nextcloud.com/server/15/admin_manual/configuration_database/mysql_4byte_support.html\">Enabling MySQL 4-byte support — Nextcloud 15 Administration Manual 15 documentation</a></p>\n\n\n\n<p>やることとしては、まず <code>/etc/my.cnf</code> に以下を追記します。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n[mysqld]\ninnodb_large_prefix=true\ninnodb_file_format=barracuda\ninnodb_file_per_table=1\n</pre>\n\n\n<p>次に <code>service mariadb restart</code> で MySQL (MariaDB) を再起動します。その後に、mysql コマンドで接続して、以下を実行します。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\nSET GLOBAL innodb_file_format=Barracuda;\nALTER DATABASE nextcloud CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;\n</pre>\n\n\n<p>これで utf8mb4 の設定は完了ですが、作成済みのテーブルは utf8 のままです。幸い、 Nextcloud のスクリプトで変更出来ますので、以下の通り実行します。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\ncd /var/www/html/nextcloud\nchmod +x occ\nsudo -u apache ./occ config:system:set mysql.utf8mb4 --type boolean --value=&quot;true&quot;\nsudo -u apache ./occ maintenance:repair\n</pre>\n\n\n<p>その他、MySQL のテーブルにインデックスが貼られていないという警告も、ついでにこの時点で直しておきましょう。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\nsudo -u apache ./occ db:add-missing-indices\n</pre>\n\n\n<h3>15 -&gt; 16 は画面で</h3>\n\n\n\n<p>15 -&gt; 16 も管理画面から行えます。</p>\n\n\n\n<h3>その他の細かい設定</h3>\n\n\n\n<p>その他、管理画面に出ていた細かい警告を修正しました。</p>\n\n\n\n<p><code>/etc/php.ini</code> でメモリ設定を変更</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\nmemory_limit = 512M\n</pre>\n\n\n<p>推奨パッケージのインストールと、DBの型の変更</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\nyum install php72u-intl\nsudo -u apache ./occ db:convert-filecache-bigint\n</pre>\n\n\n<p>細かい警告はまだ出ていますが、ここまでで大体使える状態になっていると思います。</p>\n\n\n\n<h2>高度な話題</h2>\n\n\n\n<h3>外部の認証機構を使う</h3>\n\n\n\n<p>デフォルトだと、Nextcloud サーバー内の DB でユーザーを管理しますが、外部で管理したいというのは良くあるニーズです。定番の LDAP に加え、IMAP, SMB, FTP, SSH, WebDAV, 標準認証, あるいは XMPP （詳しくはよく分かってません）といった認証方式に対応しているようです。</p>\n\n\n\n<ul><li><a href=\"https://docs.nextcloud.com/server/stable/admin_manual/configuration_user/user_auth_ldap.html\">User authentication with LDAP — Nextcloud latest Administration Manual latest documentation</a></li><li><a href=\"https://github.com/nextcloud/user_external#readme\">nextcloud/user_external: 👥 External user authentication methods like IMAP, SMB and FTP</a></li></ul>\n\n\n\n<p>今回は、諸々の事情により、メールサーバーに登録されているユーザーが Nextcloud にもアクセス出来るようにする必要があったため、IMAP を使用しました。具体的な設定方法は以下の通りです。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\ncd /var/www/html/nextcloud\nsudo -u apache ./occ app:enable user_external\n</pre>\n\n\n<p><code>/var/www/html/nextcloud/config/config.php</code> に、以下のような記述を追記します。各パラメーターの意味は、上述の user_external のページをご参照下さい。</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n'user_backends' =&gt; array(\n    array(\n        'class' =&gt; 'OC_User_IMAP',\n        'arguments' =&gt; array(\n            '127.0.0.1', 993, 'ssl', 'example.com', true, false\n        ),\n    ),\n),\n</pre>\n\n\n<p>その後、念のため、 apache を再起動して完了です。</p>\n\n\n\n<h3>冗長性の確保</h3>\n\n\n\n<p>業務のファイルを扱うので冗長性を確保したいというのも良くある要望です。（どの程度の冗長性が必要か、どういった事象を考慮するか、とかその辺の細かい話はおいておくとして、）これに関して少し調べた結果、簡単に実現する方法は無さそうです。</p>\n\n\n\n<p>考えられる案としては、以下のような稼働系-待機系パターンでしょうか。</p>\n\n\n\n<ul><li>インスタンスをもう1つ用意する（イメージ作成 -&gt; 復元等で簡単に実現できる）</li><li>DB は、MySQL のレプリケーションを使用する</li><li>ファイルの保管場所はローカルディスクでは無く、共有ディスクあるいは S3 にする</li><li>稼働系が落ちたら、手動で切り替える</li></ul>\n\n\n\n<p>ちなみに、今回はそこまでの可用性は必要無いので、とりあえず ConoHa の自動バックアップ機能を設定して、最低限の備えとする事にしました。</p>\n\n\n\n<p><a href=\"https://www.conoha.jp/vps/function/autobk/\">自動バックアップ｜VPSならConoHa</a></p>\n\n\n\n<h2>Nextcloud クライアント</h2>\n\n\n\n<p>ここまではずっとサーバー側の話をしてきましたが、Nextcloud を使うには、（Dropbox と同様に）各自の PC にクライアントソフトを入れる必要があります。</p>\n\n\n\n<h3>Mac 版は今回の環境では動かず</h3>\n\n\n\n<p>検証のため、Windows と Mac のクライアントソフトを両方使ってみましたが、Mac の場合は（恐らく）バグのため上手く動作しませんでした。バグ報告はしておきましたが、2019/8/13 現在で 681 個の issue がオープンされているので、恐らく当面は修正されない気がします。</p>\n\n\n\n<p><a href=\"https://github.com/nextcloud/desktop/issues/1365\">Sync fails when Nextcloud isn&#8217;t installed in the root folder · Issue #1365 · nextcloud/desktop</a></p>\n\n\n\n<p>上の issue に書いた通り、Nextcloud がサーバーのサブディレクトリに配置されていると起きる問題のようで、ルートディレクトリ直下にインストールすれば問題が起きないと思います。ただ、ConoHa と「さくら」のどちらとも、インストールスクリプトを使うと <code>http://ホスト名/nextcloud</code> にインストールされてしまうので、Mac ユーザーが多い環境では、スタートアップスクリプトではなくマニュアルで Nextcloud をインストールする必要があります。</p>\n\n\n\n<h3>Windows 版は今のところ問題なし</h3>\n\n\n\n<p>Windows の場合は今のところ大きな問題は出ていません。</p>\n\n\n\n<h2>まとめ</h2>\n\n\n\n<p>Nextcloud は、オープンソース版の Dropbox のようなものです。大きな組織では素直に Box や Dropbox を使うのがベストプラクティスだと思いますが、数人程度の組織・チームだとそこまで容量・機能が必要で無い事も多いので、Nextcloud を自前のサーバーに入れて使うというのも1つの選択肢です。</p>\n\n\n\n<p>Nextcloud のセットアップは手動でやると若干面倒そうなので、ConoHa VPS やさくらのVPS が提供しているスタートアップスクリプトを上手く活用するのが良いのですが、ConoHa のスタートアップスクリプトでインストールされるのは古いバージョンなので注意が必要です。海外の VPS などでも Nextcloud が簡単に使えるようになっているところがいっぱいあるので、以下のページから探してみて下さい。</p>\n\n\n\n<p><a href=\"https://nextcloud.com/providers/\">Providers – Nextcloud</a></p>\n","dateObject":"2019-08-15T23:21:00.000Z","date":"August 15, 2019","categories":[{"name":"Uncategorized","slug":"uncategorized"}],"tags":[{"name":"ConoHa","slug":"conoha"},{"name":"Nextcloud","slug":"nextcloud"}],"author":{"name":"中の人（管理者）","slug":"engineering_8qmk0b"},"featured_media":{"media_details":{"sizes":{"large":null,"medium_large":null}},"source_url":"https://stg-engineering-wp.mobalab.net/wp-content/uploads/2019/08/nextcloud-favicon-fb.png"},"wordpress_id":1071}},"pageContext":{"id":"073ed065-27db-5f0f-920f-1e24b3f9139b","nextPath":"/2019/08/08/package-jsonとpackage-lock-jsonの運用方法について/","nextTitle":"package.jsonとpackage-lock.jsonの運用方法について","prevPath":"/2019/08/16/enable-github-darkmode-with-stylish/","prevTitle":"（小ネタ）GitHubDarkを使ってGitHubをダークモードなUIにする"}}}