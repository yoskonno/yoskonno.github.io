{"componentChunkName":"component---src-templates-post-js","path":"/2019/05/31/validate-checksum-with-remote-file-using-md5sum/","result":{"data":{"wordpressPost":{"id":"c1637dbd-0711-5683-92ea-89974f6a70c9","title":"（小ネタ）md5sumを使ってリモートにあるファイルとのチェックサムを検証するワンライナー","excerpt":"<p>先に結論から書きます。 SSH接続した先にあるファイルとローカルファイルを比較する AWS S3上にあるファイルとローカルファイルを比較する ※S3の場合は、コンテンツをローカルにDLしてから計算している関係で、ファイル [&hellip;]</p>\n","slug":"validate-checksum-with-remote-file-using-md5sum","content":"\n<p>先に結論から書きます。</p>\n\n\n\n<p><strong>SSH接続した先にあるファイルとローカルファイルを比較する</strong></p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n$ ssh user@host md5sum /path/to/remote/hoge.txt | awk '{ print $1 }' /path/to/local/hoge.txt | md5sum -c\n/path/to/local/hoge.txt: OK\n</pre>\n\n\n<p><strong>AWS S3上にあるファイルとローカルファイルを比較する</strong></p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n$ echo `aws s3 cp s3://path/to/remote/hoge.txt - | md5sum | awk '{ print $1 }'` /path/to/local/hoge.txt | md5sum -c\n/path/to/local/hoge.txt: OK\n</pre>\n\n\n<p>※S3の場合は、コンテンツをローカルにDLしてから計算している関係で、ファイルのサイズが大きい場合は要注意です。</p>\n\n\n\n<h2 id=\"背景\"><a href=\"https://hackmd.io/xefT2StgRaeRXObYhHdQyA?view#%E8%83%8C%E6%99%AF\"></a>背景</h2>\n\n\n\n<p>昨今では、ソフトウェアや関連するファイルの配信は自動化する事がほとんどかと思います。</p>\n\n\n\n<p>我々も、とあるプロジェクトでシェルスクリプトのLinuxサーバーへの配置したり、Sparkで使っているJarアーカイブのS3への配置などをAnsibleを使って行っています。</p>\n\n\n\n<p>この際、正しくデプロイできたかどうかの指標として&nbsp;<code>md5sum</code>&nbsp;を使う事があります。<br>Ansibleを使っていれば何かしらのファイルで失敗した時にコマンド自体が失敗するのでそこまで心配する必要も無いかと思いますが、実行したコマンドがそもそも正しかったか等、心配性なので気になります。（※）</p>\n\n\n\n<p>複数ファイルを配置する際は、対象ファイルのうち1つでも検証に成功すればOKとしています。<br>また、Ansibleを修正した時のPullReqを作る際、Descriptionにこの結果を書いておくと親切です。</p>\n\n\n\n<p>※このプロジェクトでは毎回デプロイ対象が一定でないのと、リリース回数が少ないので完全自動化はしていないです。</p>\n\n\n\n<h2 id=\"md5sumコマンドについて\"><a href=\"https://hackmd.io/xefT2StgRaeRXObYhHdQyA?view#md5sum%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"></a>md5sumコマンドについて</h2>\n\n\n\n<p>glibcの一つで、その名の通り入力されたデータのmd5を計算します。<br>使い方は主にこんな感じです:</p>\n\n\n\n<p><strong>ローカルファイルや標準入力から計算</strong></p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n# /bin/sh ファイルのmd5\n$ md5sum /bin/sh\ne02ea3c3450d44126c46d658fa9e654c  /bin/sh\n\n# 文字列 &quot;md5&quot; のmd5\n$ echo 'md5' | md5sum\n772ac1a55fab1122f3b369ee9cd31549  -\n\n# ファイルを複数指定した場合\n$ md5sum /bin/sh /bin/bash\ne02ea3c3450d44126c46d658fa9e654c  /bin/sh\n5e666695cf08d1638bb85684e30185ee  /bin/bash\n</pre>\n\n\n<p><strong>チェックサムの確認</strong></p>\n\n\n\n<p><code>-c</code>&nbsp;を付けて、その後&nbsp;<code>md5sum</code>&nbsp;が出力する形式の内容をローカルファイル、または標準入力から入力します（複数可）</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n$ md5sum /bin/sh | md5sum -c\n/bin/sh: OK\n\n# 以下も同じ\n$ echo 'e02ea3c3450d44126c46d658fa9e654c  /bin/sh' | md5sum -c\n/bin/sh: OK\n\n# 複数も可\n$ md5sum /bin/sh /bin/bash | md5sum -c\n/bin/sh: OK\n/bin/bash: OK\n</pre>\n\n\n<p>入力する形式ですが、&nbsp;<code>{MD5メッセージ} {ファイルパス}</code>&nbsp;または、BSD形式である&nbsp;<code>MD5 ({ファイルパス}) = {MD5メッセージ}</code>&nbsp;となっていれば良いみたいです。なので、以下のようにする事でSSH経由でチェックサムの検証が行えます:</p>\n\n\n<pre class=\"brush: plain; title: ; notranslate\" title=\"\">\n$ echo `ssh user@host md5sum /path/to/remote/hoge.txt | awk '{ print $1 }'`  | /path/to/local/hoge.txt | md5sum -c\n/path/to/local/hoge.txt: OK\n</pre>\n\n\n<p>※接続先にも&nbsp;<code>md5sum</code>&nbsp;が入っている事が必須になります。<br><code>awk</code>を使って、結果からファイル名を取り除いているのがみそです。</p>\n\n\n\n<hr class=\"wp-block-separator\"/>\n\n\n\n<p>全然関係無いですが、今日はプレミアムフライデーですね。皆さんの会社でも定着していますか？<br>実は弊社もプレミアムフライデーを採用しているので、今日はこの後切りの良いところで終えようと思います。（笑）<br>また、弊社ではフルリモートで働けるメンバーを募集しています！他にも働きやすさを重視した取り組みや改善を行っていますので、興味のある方は↓の採用ページをご覧ください！</p>\n","dateObject":"2019-05-31T01:00:34.000Z","date":"May 31, 2019","categories":[{"name":"Uncategorized","slug":"uncategorized"}],"tags":[{"name":"gnu","slug":"gnu"},{"name":"md5","slug":"md5"},{"name":"md5sum","slug":"md5sum"}],"author":{"name":"issei_m","slug":"issei"},"featured_media":{"media_details":{"sizes":{"large":{"source_url":"https://i2.wp.com/stg-engineering-wp.mobalab.net/wp-content/uploads/2019/05/photo-1547190027-9156686aa2f0.jpeg?fit=1024%2C683&ssl=1","height":683,"width":1024},"medium_large":{"source_url":"https://i2.wp.com/stg-engineering-wp.mobalab.net/wp-content/uploads/2019/05/photo-1547190027-9156686aa2f0.jpeg?fit=768%2C512&ssl=1","height":512,"width":768}}},"source_url":"https://stg-engineering-wp.mobalab.net/wp-content/uploads/2019/05/photo-1547190027-9156686aa2f0.jpeg"},"wordpress_id":900}},"pageContext":{"id":"c1637dbd-0711-5683-92ea-89974f6a70c9","nextPath":"/2019/05/20/install-postfix-on-ubuntu-by-ansible/","nextTitle":"Ansible で Ubuntu に postfix をインストール","prevPath":"/2019/06/10/aws-lambda上でwebスクレイピング/","prevTitle":"AWS Lambda上でWebスクレイピング"}}}