{"componentChunkName":"component---src-templates-post-js","path":"/2019/07/23/tips-of-eager-loading-in-laravel/","result":{"data":{"wordpressPost":{"id":"2fd15074-57ab-5bb5-bbbc-2c90375eccd9","title":"Laravel の eager loading に関する小ネタ","excerpt":"<p>はじめに Laravel や Rails のようなフレームワークでは、N+1問題を回避するために eager loading を使用する事が一般的です。本記事では、Laravel の eager loading に関する [&hellip;]</p>\n","slug":"tips-of-eager-loading-in-laravel","content":"\n<h2>はじめに</h2>\n\n\n\n<p>Laravel や Rails のようなフレームワークでは、N+1問題を回避するために eager loading を使用する事が一般的です。本記事では、Laravel の eager loading に関する小ネタをいくつか書いていきます。</p>\n\n\n\n<p>Laravel の eager loading 自体に関しては、ドキュメントに詳しく記述されていますので、まずは一通り目を通す事をオススメします。</p>\n\n\n\n<ul><li>英語: <a href=\"https://laravel.com/docs/5.8/eloquent-relationships#eager-loading\">Eloquent: Relationships &#8211; Laravel &#8211; The PHP Framework For Web Artisans</a></li><li>日本語: <a href=\"https://readouble.com/laravel/5.8/ja/eloquent-relationships.html#eager-loading\">Eloquent：リレーション 5.8 Laravel</a></li></ul>\n\n\n\n<h2>件数を事前に取得する</h2>\n\n\n\n<p>実は、上述のドキュメントの eager loading の項ではなく、1つ前の項（Querying Relations -&gt; Counting Related Models）に記載があるのですが、eater loading の書式（<code>::with('table')</code>）と似たような書式（<code>::withCount('table')</code>）で、子テーブルの件数を事前に取得する事が出来ます。</p>\n\n\n\n<p>分かりやすい使用例としては、ブログ記事一覧を表示する際に、各記事についているコメント数も合わせて表示する、というのがあります。（上述のドキュメントでも、この例が載っています。）</p>\n\n\n\n<p>例えば、以下のようなコードがあった場合、</p>\n\n\n<pre class=\"brush: php; title: ; notranslate\" title=\"\">\n$posts = App\\Post::withCount('comments')-&gt;take(10)-&gt;get();\n</pre>\n\n\n<p>実行される SQL は以下のようなものです。</p>\n\n\n<pre class=\"brush: sql; title: ; notranslate\" title=\"\">\nselect `posts`.*\n  , (select count(*) from `comments` where `posts`.`id` = `comments`.`post_id`) as `comments_count`\nfrom `posts` limit 10\n</pre>\n\n\n<h3>lazy にやるには</h3>\n\n\n\n<p>lazy に eager loading をする方法はドキュメントに記載されていますが、件数の取得を lazy に行うにはどうすれば良いでしょうか。</p>\n\n\n\n<p>Laravel 5.8 からは <code>loadCount</code> メソッドというのが追加されており、<code>load</code> で lazy に eager loading を行うのと同じように、件数も lazy に取得する事ができます。以下の SO の投稿で知りました。</p>\n\n\n\n<p><a href=\"https://stackoverflow.com/questions/tagged/eloquent\">Laravel Eloquent Lazy Eager Load Count &#8211; Stack Overflow</a></p>\n\n\n\n<h2>複数のカラムでリレーションしている場合</h2>\n\n\n\n<p>Rails や、Rails に影響を受けている Laravel のようなフレームワークでは、複合主キーは使わず、連番のサロゲートキーを使う事が（それ自体の是非や好き嫌いはさておき）ベストプラクティスです。</p>\n\n\n\n<p>ただ、現実の場面では、複数のカラムの値を使って子テーブルを読み込まなければいけないケースは多々あると思います。普通に読み込むだけであれば <code>hasMany</code> や <code>hasOne</code> の後ろに <code>where</code> で条件を絞れば良いのですが、それだと eager loading が正しく動作しません。</p>\n\n\n\n<p>それを解決するために、以下のようなモジュールがありました。</p>\n\n\n\n<p><a href=\"https://github.com/topclaudy/compoships\">topclaudy/compoships: Multi-columns relationships for Laravel 5&#8217;s Eloquent</a></p>\n\n\n\n<p>この辺りの話題は SO の以下のスレッドを参照して下さい。</p>\n\n\n\n<p><a href=\"https://stackoverflow.com/questions/48077890/laravel-eloquent-multiple-foreign-keys-for-relationship\">Laravel Eloquent: multiple foreign keys for relationship &#8211; Stack Overflow</a></p>\n\n\n\n<h2>まとめ</h2>\n\n\n\n<p>Web アプリのパフォーマンス問題を解決するには、eager loading を上手く使う事が必須です。</p>\n\n\n\n<p>Laravel の eager loading は機能が豊富で、標準の機能だけで大半の問題は解決できると思いますので、まずはドキュメントを一通り読む事をお勧めします。</p>\n\n\n\n<p>複合キーの問題は、この手のフレームワークを使う時に定番の話題だと思います。Laravel を使う場合は、できる限り複合キーを排除した方が良いのですが、複合キーで参照している子テーブルを eager loading したい場合は、Comphoships モジュールの導入を検討してみて下さい。</p>\n","dateObject":"2019-07-23T00:09:32.000Z","date":"July 23, 2019","categories":[{"name":"Uncategorized","slug":"uncategorized"}],"tags":[{"name":"laravel","slug":"laravel"}],"author":{"name":"中の人（管理者）","slug":"engineering_8qmk0b"},"featured_media":{"media_details":{"sizes":{"large":null,"medium_large":{"source_url":"https://i2.wp.com/stg-engineering-wp.mobalab.net/wp-content/uploads/2019/07/Laravel.gif?fit=768%2C521&ssl=1","height":521,"width":768}}},"source_url":"https://stg-engineering-wp.mobalab.net/wp-content/uploads/2019/07/Laravel.gif"},"wordpress_id":1028}},"pageContext":{"id":"2fd15074-57ab-5bb5-bbbc-2c90375eccd9","nextPath":"/2019/07/01/react-jsのコードをtypescript化する/","nextTitle":"React.jsのコードをTypeScript化する","prevPath":"/2019/08/02/using-iam-db-auth-in-postgres-rds/","prevTitle":"PostgreSQLなRDSでIAM Database Authenticationを使ってみた"}}}