{"componentChunkName":"component---src-templates-post-js","path":"/2018/06/06/build-node-native-module-using-docker-for-lambda/","result":{"data":{"wordpressPost":{"id":"98060c9e-f87c-5c1a-9cd6-bf08707b8134","title":"Dockerã§AWS Lambdaç”¨ã®Node.jsãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹","excerpt":"<p>å…ˆæ—¥ã€AWS Lambdaã®Node.jsã§iconvã‚’ä½¿ã†ã®ãŒå¤§å¤‰ã ã£ãŸä»¶ã¨è¨€ã†è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸãŒã€ãã®å¾Œã™ãã€AWSãŒAmazon Linuxç”¨ã®å…¬å¼Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…¬é–‹ã—ã¦ã„ã‚‹äº‹ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚ ãã“ã§ã€å‰å›ã¯ [&hellip;]</p>\n","slug":"build-node-native-module-using-docker-for-lambda","content":"<p>å…ˆæ—¥ã€<a href=\"https://stg-engineering-wp.mobalab.net/2018/05/17/aws-lambda%E3%81%AEnode-js%E3%81%A7iconv%E3%82%92%E4%BD%BF%E3%81%86%E3%81%AE%E3%81%8C%E5%A4%A7%E5%A4%89%E3%81%A0%E3%81%A3%E3%81%9F%E4%BB%B6/\">AWS Lambdaã®Node.jsã§iconvã‚’ä½¿ã†ã®ãŒå¤§å¤‰ã ã£ãŸä»¶</a>ã¨è¨€ã†è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸãŒã€ãã®å¾Œã™ãã€AWSãŒAmazon Linuxç”¨ã®å…¬å¼Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…¬é–‹ã—ã¦ã„ã‚‹äº‹ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚<br />\nãã“ã§ã€å‰å›ã¯EC2ä¸Šã®Amazon Linuxã§Node.jsã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã—ãŸãŒã€ä»Šå›ã¯Dockerã‚’ä½¿ã£ãŸæ–¹æ³•ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚</p>\n<p>å°šã€ä½¿ç”¨ã—ãŸç’°å¢ƒã¯macOS High Sierra (10.13.5) + Docker for Mac (18.05.0-ce-mac66, channel: edge)ã§ã™ã€‚</p>\n<h2>Amazon Linuxã‚¤ãƒ¡ãƒ¼ã‚¸</h2>\n<p>Docker Hubã«å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚â†’ <a href=\"https://hub.docker.com/r/library/amazonlinux/\">https://hub.docker.com/r/library/amazonlinux/</a><br />\n<a href=\"https://hub.docker.com/r/library/amazonlinux/tags/\">ã‚¿ã‚°ã®ä¸€è¦§</a>ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ã‹ãªã‚Šç´°ã‹ããƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚</p>\n<p>å°šã€AWS Lambdaã§ã¯ç¾åœ¨ã®æ‰€<a href=\"https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/current-supported-versions.html\">Amazon Linux (amzn-ami-hvm-2017.03.1.20170812-x86_64-gp2) ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹</a>ã®ã§ã€ãã‚Œã«ä½µã›ã¦ä»Šå›ã¯amazonlinux:2017.03.1.20170812ã‚’ä½¿ã£ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Pullã—ã¦ãã¾ã™:</p>\n<pre><code>$ docker pull amazonlinux:2017.03.1.20170812\n</code></pre>\n<h2>ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ç‚ºã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹</h2>\n<p>æº–å‚™ãŒæ•´ã£ãŸã®ã§æ—©é€Ÿä½œã£ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã€å…ˆç¨‹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã™:</p>\n<pre><code>$Â docker run -it --name native-node amazonlinux:2017.03.1.20170812\nbash-4.2#\n</code></pre>\n<p>â€»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ /bin/bash ãŒèµ·å‹•ã™ã‚‹ã‚ˆã†è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚</p>\n<p>æ¬¡ã«Node.jsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ä»Šå›ã¯AWS Lambdaã§v8.10ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ã„ãŸã„ã®ã§ã€ãã‚Œã«ä½µã›ã¦8ç³»ã®ç‰©ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚<br />\n<a href=\"https://nodejs.org/en/download/package-manager/#enterprise-linux-and-fedora\">å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®RHELç³»ã§ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †</a>ã«å¾“ã„ã€ã¾ãšrpmã‚’å–å¾—ã—ã¾ã™ (rootãªã®ã§sudoã¯çœç•¥ã—ã¾ã™) :</p>\n<pre><code>bash-4.2# curl -sL https://rpm.nodesource.com/setup_8.x | bash -\n...\n## Run `sudo yum install -y nodejs` to install Node.js 8.x LTS Carbon and npm.\n## You may also need development tools to build native addons:\nsudo yum install gcc-c++ make\n## To install the Yarn package manager, run:\ncurl -sL https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo\nsudo yum install yarn\n</code></pre>\n<p>å‡ºåŠ›ãŒä¸Šè¨˜ã®ã‚ˆã†ãªå½¢ã§çµ‚ã‚ã‚Œã°æˆåŠŸã§ã™ã€‚ã“ã®å¾Œã‚³ãƒ¡ãƒ³ãƒˆã®é€šã‚Šã€yumã‚’ä½¿ã£ã¦Node.jsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã§ã™ãŒã€ &#8220;You may also need development tools to build native addons: sudo yum install gcc-c++ make&#8221; ã«ã‚‚ã‚ã‚‹é€šã‚Šã€ã¾ã•ã—ãä»Šå›ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã®ã§ã€ã“ã‚Œã‚‰ã‚‚ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å¾“ã£ã¦ã€ã‚³ãƒãƒ³ãƒ‰ã¯æ¬¡ã®é€šã‚Šã«ãªã‚Šã¾ã™:</p>\n<pre><code>bash-4.2# yum install -y nodejs gcc-c++ make\n...\n\nInstalled:\ngcc-c++.noarch 0:4.8.5-1.22.amzn1 nodejs.x86_64 2:8.11.2-1nodesource\n\nDependency Installed:\nbinutils.x86_64 0:2.25.1-31.base.66.amzn1 cpp48.x86_64 0:4.8.5-28.142.amzn1 gcc.noarch 0:4.8.5-1.22.amzn1\ngcc48.x86_64 0:4.8.5-28.142.amzn1 gcc48-c++.x86_64 0:4.8.5-28.142.amzn1 glibc-devel.x86_64 0:2.17-222.173.amzn1\nglibc-headers.x86_64 0:2.17-222.173.amzn1 kernel-headers.x86_64 0:4.14.42-52.37.amzn1 libgomp.x86_64 0:6.4.1-1.45.amzn1\nlibmpc.x86_64 0:1.0.1-3.3.amzn1 mpfr.x86_64 0:3.1.1-4.14.amzn1 python26.x86_64 0:2.6.9-2.89.amzn1\npython26-libs.x86_64 0:2.6.9-2.89.amzn1\n\nDependency Updated:\nglibc.x86_64 0:2.17-222.173.amzn1 glibc-common.x86_64 0:2.17-222.173.amzn1 libgcc48.x86_64 0:4.8.5-28.142.amzn1\nlibstdc++48.x86_64 0:4.8.5-28.142.amzn1 nss-softokn-freebl.x86_64 0:3.28.3-8.41.amzn1\n\nComplete!\n</code></pre>\n<p>ç„¡äº‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸã€‚Node.jsã¯8.11ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸãŒã€ãŠãã‚‰ãå•é¡Œãªã„ã§ã—ã‚‡ã†ã€‚</p>\n<p>ãã‚Œã§ã¯ã€æ—©é€Ÿãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚<a href=\"https://stg-engineering-wp.mobalab.net/2018/05/17/aws-lambda%E3%81%AEnode-js%E3%81%A7iconv%E3%82%92%E4%BD%BF%E3%81%86%E3%81%AE%E3%81%8C%E5%A4%A7%E5%A4%89%E3%81%A0%E3%81%A3%E3%81%9F%E4%BB%B6/\">å‰å›</a>ã¨åŒæ§˜ã€iconvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚<br />\nãƒ†ã‚¹ãƒˆãªã®ã§ã€/tmpã«ç§»å‹•ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™:</p>\n<pre><code>bash-4.2# cd /tmp\nbash-4.2# npm install iconv\n\n&gt; iconv@2.3.0 install /tmp/node_modules/iconv\n&gt; node-gyp rebuild\n\nmake: Entering directory `/tmp/node_modules/iconv/build'\nCXX(target) Release/obj.target/iconv/src/binding.o\nCC(target) Release/obj.target/iconv/deps/libiconv/lib/iconv.o\nCC(target) Release/obj.target/iconv/support/localcharset.o\nSOLINK_MODULE(target) Release/obj.target/iconv.node\nCOPY Release/iconv.node\nmake: Leaving directory `/tmp/node_modules/iconv/build'\nnpm WARN saveError ENOENT: no such file or directory, open '/tmp/package.json'\nnpm notice created a lockfile as package-lock.json. You should commit this file.\nnpm WARN enoent ENOENT: no such file or directory, open '/tmp/package.json'\nnpm WARN tmp No description\nnpm WARN tmp No repository field.\nnpm WARN tmp No README data\nnpm WARN tmp No license field.\n\n+ iconv@2.3.0\nadded 2 packages in 6.425s\n</code></pre>\n<p>ç„¡äº‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã§ããŸã¿ãŸã„ã§ã™ã€‚iconvã®å ´åˆã€ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¯node_modules/iconv/build/Release/iconv.nodeä»¥ä¸‹ã«é…ç½®ã•ã‚Œã‚‹ã®ã§ã™ãŒã€ãã¡ã‚“ã¨ã§ãã¦ã„ã¾ã™ã€‚</p>\n<pre><code>bash-4.2# ls -la node_modules/iconv/build/Release/iconv.node\n-rwxr-xr-x 1 root root 1119920 Jun 5 05:53 node_modules/iconv/build/Release/iconv.node\n</code></pre>\n<p>å•é¡Œã¯ã€ã“ã‚ŒãŒLambdaã§å‹•ãã‹ã©ã†ã‹ãªã®ã§ã™ãŒã€å‰å›ã€EC2ä¸Šã§ãƒ“ãƒ«ãƒ‰ã—ãŸãƒã‚¤ãƒŠãƒªã®md5ã¯ <code>216d4e9181fc621c4500e1a6760f9e3f</code>Â ã§ã—ãŸã€‚<br />\nä»Šå›ã®ãƒã‚¤ãƒŠãƒªã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ <code>md5sum</code>Â ã§æ¤œè¨¼ã—ã¦ã¿ã¾ã—ã‚‡ã†:</p>\n<pre><code>bash-4.2# md5sum node_modules/iconv/build/Release/iconv.node\n216d4e9181fc621c4500e1a6760f9e3f node_modules/iconv/build/Release/iconv.node\n</code></pre>\n<p>ï¼ˆå½“ç„¶ã§ã™ãŒï¼‰ä¸€è‡´ã—ã¾ã—ãŸï¼å¤§æˆåŠŸã§ã™ã€‚å› ã¿ã«ã€è©³ç´°ã¯çœãã¾ã™ãŒå®Ÿéš›ã«Lambdaä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‚å‹•ä½œã—ã¾ã—ãŸğŸ‘</p>\n<h2>ã‚³ãƒ³ãƒ†ãƒŠã®å†åˆ©ç”¨</h2>\n<p>ã•ã¦ã€ç„¡äº‹ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«æˆåŠŸã—ãŸæ‰€ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ä»Šå¾Œã‚‚å†åˆ©ç”¨ã—ã¦ã„ãç‚ºã«ã€ã‚¤ãƒ¡ãƒ¼ã‚¸åŒ–ã—ã¦ã„ããŸã„æ‰€ã§ã™ã€‚ <code>docker commit</code>Â ã‚’ä½¿ã£ã¦ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ä¿å­˜ãŒã§ãã¾ã™ãŒã€æŠ˜è§’ãªã®ã§DockerfileåŒ–ã—ã¦ãŠãã¾ã—ãŸ â†’Â <a href=\"https://github.com/issei-m/npm-for-lambda\">https://github.com/issei-m/npm-for-lambda</a></p>\n<p>Docker Hubã«ã¯å…¬é–‹ã—ã¦ã„ãªã„ã®ã§ã€æ‰‹å‹•ã§ãƒªãƒã‚¸ãƒˆãƒªã‚’cloneã—ã¦ <code>docker build</code>Â  ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:</p>\n<pre><code>$ docker build -t npm-for-lambda .\n</code></pre>\n<p>ãã®å¾Œã€npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ <code>/root</code>Â ã«ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã—ãŸçŠ¶æ…‹ã§å®Ÿè¡Œã—ã¾ã™ã€‚<br />\nå°šã€ <code>npm</code>Â ãŒENTRYPOINTã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ä»¥é™ã®ã‚³ãƒãƒ³ãƒ‰ã®ã¿ã‚’è¨˜è¿°ã™ã‚Œã°OKã§ã™:</p>\n<pre><code>$Â docker run -it --rm -v /tmp:/root npm-for-lambda install iconv\n\n&gt; iconv@2.3.0 install /root/node_modules/iconv\n&gt; node-gyp rebuild\n\nmake: Entering directory `/root/node_modules/iconv/build'\nCXX(target) Release/obj.target/iconv/src/binding.o\nCC(target) Release/obj.target/iconv/deps/libiconv/lib/iconv.o\nCC(target) Release/obj.target/iconv/support/localcharset.o\nSOLINK_MODULE(target) Release/obj.target/iconv.node\nCOPY Release/iconv.node\nmake: Leaving directory `/root/node_modules/iconv/build'\nnpm WARN saveError ENOENT: no such file or directory, open '/root/package.json'\nnpm notice created a lockfile as package-lock.json. You should commit this file.\nnpm WARN enoent ENOENT: no such file or directory, open '/root/package.json'\nnpm WARN root No description\nnpm WARN root No repository field.\nnpm WARN root No README data\nnpm WARN root No license field.\n\n+ iconv@2.3.0\nadded 2 packages in 10.784s\n</code></pre>\n<p>ç„¡äº‹ä½œã‚‰ã‚Œã¾ã—ãŸã€‚ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚‚ã°ã£ã¡ã‚Šã§ã™:</p>\n<pre><code>$Â md5 /tmp/node_modules/iconv/build/Release/iconv.node\nMD5 (/tmp/node_modules/iconv/build/Release/iconv.node) = 216d4e9181fc621c4500e1a6760f9e3f\n</code></pre>\n<h2>ãŠã‚ã‚Šã«</h2>\n<p>ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚ä»Šå›ã¯ã€ï¼ˆä»Šæ›´ãªãŒã‚‰ï¼‰DockerãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œç’°å¢ƒã ã‘ã§ãªãã€ç‰¹å®šã®ç’°å¢ƒã«å‘ã‘ã¦ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç’°å¢ƒã¨ã—ã¦ã‚‚æœ‰ç”¨ã¨è¨€ã†äº‹ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚<br />\nä»Šå¾Œã‚‚æ˜¯éæ´»ç”¨ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚</p>\n","dateObject":"2018-06-06T03:19:26.000Z","date":"June 06, 2018","categories":[{"name":"Uncategorized","slug":"uncategorized"}],"tags":[{"name":"AWS","slug":"aws"},{"name":"Docker","slug":"docker"},{"name":"Lambda","slug":"lambda"},{"name":"Node.js","slug":"node-js"}],"author":{"name":"issei_m","slug":"issei"},"featured_media":{"media_details":{"sizes":{"large":null,"medium_large":null}},"source_url":"https://stg-engineering-wp.mobalab.net/wp-content/uploads/2018/06/docker-node.png"},"wordpress_id":186}},"pageContext":{"id":"98060c9e-f87c-5c1a-9cd6-bf08707b8134","nextPath":"/2018/05/17/aws-lambdaã®node-jsã§iconvã‚’ä½¿ã†ã®ãŒå¤§å¤‰ã ã£ãŸä»¶/","nextTitle":"AWS Lambdaã®Node.jsã§iconvã‚’ä½¿ã†ã®ãŒå¤§å¤‰ã ã£ãŸä»¶","prevPath":"/2018/06/12/ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒªã®æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰/","prevTitle":"ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒªã®æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰"}}}